<html lang="en">
<head>
    <meta charset="UTF-8">


    <title>those GIRLS you.know</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            position: fixed;
            /*background-color: #000000;*/
        }

        canvas {
            width: 100%;
            height: 100%;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0); /* mobile webkit */
        }

    </style>
</head>
<body>
<script src='lib/stats.js/build/stats.min.js'></script>
<script type="module">

    import * as THREE from "./lib/three/build/three.module.js";
    import Clock from "./js/Clock.js";
    import * as Utils from "./js/Utils.js";
    import GirlLoader from "./js/Loader.js";

    // Actors
    import Tunnel from "./js/actors/tunnel/Tunnel.js";
    import Stars from "./js/actors/Stars.js";
    import Buildings from "./js/actors/Buildings.js";
    import Cutouts from "./js/actors/Cutouts.js";

    // stats to optimize performance
    let stats = new Stats();
    stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
    document.body.appendChild(stats.dom);

    // audio
    let those_girls_you_know = new Audio('music/Those Girls You Know_6.mp3');
    if (those_girls_you_know) those_girls_you_know.loop = false;
    let isPlaying = false;

    // tracking where we are in the song
    let clock = new Clock(0, 0, 0);

    // Renderers
    let rendererThree;

    // 3d objects
    let scene, camera;
    let loader = new THREE.TextureLoader();

    // groups of actors
    let actors = [];

    let turningLeft = false;
    let turningRight = false;
    let goingUp = false;
    let goingDown = false;

    // load in images, initialize 3D scene
    let girlLoader = new GirlLoader(init);

    // load images
    // load music
    // init


    function init() {
        let canvas = document.getElementById("screen");
        rendererThree = new THREE.WebGLRenderer({
            canvas: canvas
        });

        setup3d();

        document.addEventListener('keydown', onDocumentKeyDown, false);
        document.addEventListener('keyup', onDocumentKeyUp, false);
        document.addEventListener('mouseup', mouseUp, false);
        document.addEventListener('touchstart', touchStart, {passive: false});

        // starting our clock, defining start position in animation
        clock.start();
    }


    function setup3d() {
        scene = new THREE.Scene();


        rendererThree = new THREE.WebGLRenderer();

        scene.background = new THREE.Color(0x85C1E9); //#85C1E9
        scene.fog = new THREE.FogExp2('white', 0.05);
        scene.color = 0xFFFFFF;

        rendererThree.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(rendererThree.domElement);


        // floor
        let floorMaterial = new THREE.MeshStandardMaterial({
            color: 0xFFCCDD,
            roughness: 1,
            flatShading: true
        });
        let floorGeometry = new THREE.PlaneGeometry(1000, 3);
        let plane = new THREE.Mesh(floorGeometry, floorMaterial);
        // plane.position.x += 1000 / 2;
        // plane.position.y += 1000 / 2;
        // plane.position.x = Utils.locationInSong(1, 0, 0) + 1000 / 2;
        plane.position.z = -2;
        scene.add(plane);

        // light
        let dirLight;
        dirLight = new THREE.DirectionalLight(0xFFFFFF);
        // dirLight = new THREE.PointLight( 0xffffff, 1, 0 );
        dirLight.position.set(-2, 5, 3).normalize();
        // dirLight.position.set(20, 0, 100);
        dirLight.rotation.x = Math.PI / 4;
        // dirLight.castShadow = true;
        // dirLight.shadowDarkness = 0.5;
        scene.add(dirLight);

        let light = new THREE.AmbientLight(0xFFFFFF); // soft white light
        scene.add(light);

        camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 0.1, 50);
        camera.position.z = .3;
        camera.position.x = 0;
        camera.position.y = 0;
        camera.rotation.x = 90 * Math.PI / 180;
        camera.rotation.y = -90 * Math.PI / 180;
        camera.rotateOnAxis(new THREE.Vector3(-1, 0, 0), -0.1);


        addTitle(scene);

        actors.push(new Tunnel(scene, clock, girlLoader));
        actors.push(new Stars(scene, clock, girlLoader));
        actors.push(new Buildings(scene, clock, girlLoader));
        actors.push(new Cutouts(scene, clock, girlLoader));


    }

    function animate() {
        stats.begin();

        // keep track of where we are in the song
        clock.update();

        updateCamera();

        actors.forEach(group => {
            group.update(camera.position);
        });

        rendererThree.render(scene, camera);

        stats.end();
        requestAnimationFrame(animate);
    }


    function addTitle(scene) {
        let texture = loader.load('images/title card.png');
        texture.minFilter = THREE.LinearFilter;
        let material = new THREE.MeshLambertMaterial({
            map: texture,
            fog: true,
            side: THREE.DoubleSide,
            transparent: true
        });
        let scale = 6;
        let geometry = new THREE.PlaneGeometry(scale * 1000 / 1000, scale); // those girls
        let mesh = new THREE.Mesh(geometry, material);
        let loc = Utils.locationInSong(0, 2, 0);
        mesh.position.set(loc, 0, .5);
        mesh.rotation.y = -Math.PI / 2;
        mesh.rotation.x = Math.PI / 2;
        mesh.receiveShadow = false;
        mesh.castShadow = false;
        scene.add(mesh);

    }

    function updateCamera() {
        // strut
        camera.position.x = clock.eighthsFraction * 1 + Math.cos(clock.eighthsFraction * Math.PI) * 0.15;

        // bounce
        camera.position.z = Math.cos(clock.eighthsFraction * Math.PI) * 0.04;


        if (turningLeft) {
            camera.rotateOnWorldAxis(new THREE.Vector3(0, 0, 1), Math.PI / 180);
        }
        if (turningRight) {
            camera.rotateOnWorldAxis(new THREE.Vector3(0, 0, 1), -1 * Math.PI / 180);
        }
        if (goingUp) {
            camera.position.z += .2;
        }
        if (goingDown) {
            camera.position.z -= .2;
        }
    }



    function play() {
        if (!isPlaying) {
            // those_girls_you_know.oncanplaythrough = function () {
            those_girls_you_know.currentTime = clock.seconds;
            those_girls_you_know.play();
            // when music loaded, animate
            isPlaying = true;
            animate();
            // };
        }
    }


    function onDocumentKeyDown(event) {
        play();

        let keyCode = event["which"];
        if (keyCode === 37) {
            turningLeft = true;
        } else if (keyCode === 39) {
            turningRight = true;
        }

        if (keyCode === 37 || keyCode === 65) {
            turningLeft = true;
        } else if (keyCode === 38 || keyCode === 87) {
            goingUp = true;
        } else if (keyCode === 39 || keyCode === 68) {
            turningRight = true;
        } else if (keyCode === 40 || keyCode === 83) {
            goingDown = true;
        }
    }

    function onDocumentKeyUp(event) {
        let keyCode = event["which"];
        if (keyCode === 37 || keyCode === 65) {
            turningLeft = false;
        } else if (keyCode === 38 || keyCode === 87) {
            goingUp = false;
        } else if (keyCode === 39 || keyCode === 68) {
            turningRight = false;
        } else if (keyCode === 40 || keyCode === 83) {
            goingDown = false;
        }
    }

    function mouseUp(event) {
        play();
    }

    function touchStart(event) {
        play();
    }



</script>
<canvas id="screen">
    <h1>THOSE GIRLS YOU KNOWT</h1>

    <p>
        Those girls you know<br>
        Looking at the lenses of their phone<br>
        Minimize their blemishes<br>
        With downward angles<br>
        And tag<br>
        Their thoughts
    </p>

    <p>
        Now when you are<br>
        Following the mentions of a star<br>
        Their catchy, sassy, cutesy captions<br>
        Are designed to win<br>
        Your heart
    </p>

    <p>
        Underneath their makeup<br>
        Branding with their clothes<br>
        Underneath their makeup are those GIRLS
    </p>

    <p>
        Underneath your make up<br>
        Practicing your pose<br>
        Underneath your make up are those...
    </p>

    <p>
        ...Girls you know<br>
        Looking at the lenses of your phone<br>
        Minimize your blemishes<br>
        With downward angles<br>
        And tag<br>
        your thoughts

    </p>

</canvas>

</body>
</html>
