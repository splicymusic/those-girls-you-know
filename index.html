<html lang="en">
<head>
    <meta charset="UTF-8">


    <title>those GIRLS you.know</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            position: fixed;
            background-color: #000000;
        }

        canvas {
            width: 100%;
            height: 100%;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0); /* mobile webkit */
        }

    </style>
</head>
<body>
<script src='lib/stats.js/build/stats.min.js'></script>
<script src='lib/pixi.min.js'></script>
<script type="module">

    import * as THREE from "./lib/three/build/three.module.js";
    import Clock from "./js/Clock.js";
    import * as Utils from "./js/Utils.js";
    import GirlLoader from "./js/3d/GirlLoader.js";

    // stats
    let stats = new Stats();
    stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
    document.body.appendChild(stats.dom);

    //2D
    // try: https://stackoverflow.com/questions/19002850/custom-font-in-pixi-js
    // const loader = new PIXI.loaders.Loader();
    // loader.add('alba', 'fonts/ALBAS___.TTF');

    // audio
    let those_girls_you_know = new Audio('music/Those Girls You Know_5.mp3');
    if (those_girls_you_know) those_girls_you_know.loop = false;
    let isPlaying = false;


    // let audioContext = null;

    let clock;


    // Renderers
    let rendererThree;
    let rendererPixi;

    // 3d objects
    let scene, camera;
    let loader = new THREE.TextureLoader();

    let turningLeft = false;
    let turningRight = false;

    // load in images, initialize 3D scene
    let girlLoader = new GirlLoader(init);


    function init() {
        let canvas = document.getElementById("screen");
        rendererThree = new THREE.WebGLRenderer({
            canvas: canvas
        });
        rendererPixi = new PIXI.Renderer({
            view: canvas,
            context: rendererThree.getContext()
        });

        setup3d();

        document.addEventListener('keydown', onDocumentKeyDown, false);
        document.addEventListener('keyup', onDocumentKeyUp, false);

        // starting our clock, defining start position in animation
        clock = new Clock(0, 0, 0);
    }





    function animate() {
        stats.begin();

        // keep track of where we are in the song
        clock.update();

        rendererThree.state.reset();
        render3d();
        rendererThree.state.reset();

        rendererPixi.reset();
        render2d();
        rendererPixi.reset();

        stats.end();
        requestAnimationFrame(animate);
    }

    function setup3d() {
        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 0.1, 50);
        rendererThree = new THREE.WebGLRenderer();

        scene.background = new THREE.Color('pink'); //#85C1E9
        scene.fog = new THREE.FogExp2('white', 0.05);
        scene.color = 0xFFFFFF;

        rendererThree.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(rendererThree.domElement);

        let shinyMaterial = new THREE.MeshStandardMaterial({
            color: 0x95D1F9,
            roughness: 1,
            flatShading: true
        });

        let arenaSize = 50;
        let canyonWidth = 6;
        let leftBound = -canyonWidth;
        let rightBound = canyonWidth;
        for (let i = 0; i < 500; i++) {
            let cubeX = randomInt(arenaSize);
            let cubeY = randomInt(arenaSize) - arenaSize / 2;
            if (cubeY > leftBound && cubeY < rightBound) continue;
            let geometry = new THREE.BoxGeometry(1, 1, randomInt(15) + 5);
            let cube = new THREE.Mesh(geometry, shinyMaterial);

            cube.position.x = cubeX;
            cube.position.y = cubeY;
            scene.add(cube);
        }

        // floor
        let floorMaterial = new THREE.MeshStandardMaterial({
            color: 0xEEEEFF,
            roughness: 1,
            flatShading: true
        });
        let floorGeometry = new THREE.PlaneGeometry(1000, 1000);
        let plane = new THREE.Mesh(floorGeometry, floorMaterial);
        // plane.position.x += 1000 / 2;
        // plane.position.y += 1000 / 2;
        plane.position.z = -2;
        scene.add(plane);

        // light
        let dirLight;
        dirLight = new THREE.DirectionalLight(0xFFFFFF);
        dirLight.position.set(-2, 5, 3).normalize();
        scene.add(dirLight);

        let light = new THREE.AmbientLight(0xFFFFFF); // soft white light
        scene.add(light);

        camera.position.z = 0;
        camera.position.x = 0;
        camera.position.y = 0;
        camera.rotation.x = 90 * Math.PI / 180;
        camera.rotation.y = -90 * Math.PI / 180;
        camera.rotateOnAxis(new THREE.Vector3(-1, 0, 0), -0.1);

        addTitleImage(scene);
        addDiana(scene);



    }

    function addTitleImage(scene) {

        //let texture = loader.load('images/girls/Bo Derek/Bo Derek.jpg');
        let keys = Object.keys(girlLoader.girls);



        // preserve ratio
        let scale = 2;

        let boStart = Utils.locationInSong(1, 0, 0);
        for (let i = 0; i < 100; i++) {
            let key = keys[i % keys.length];
            let texture = girlLoader.girls[key];
            let geometry = new THREE.BoxBufferGeometry(.1, scale, scale * texture.image.width / texture.image.height);
            let sideColor = 0x85C1E9;
            let cubeMaterial = [
                new THREE.MeshBasicMaterial({
                    map: texture, //left
                    fog: true,
                }),
                new THREE.MeshBasicMaterial({
                    map: texture, //right
                    fog: true,
                }),
                new THREE.MeshBasicMaterial({
                    color: sideColor, // top
                    fog: true,
                }),
                new THREE.MeshBasicMaterial({
                    color: sideColor, // bottom
                    fog: true,
                }),
                new THREE.MeshBasicMaterial({
                    color: sideColor, // front
                    fog: true,
                }),
                new THREE.MeshBasicMaterial({
                    color: sideColor, //back
                    fog: true,
                })
            ];

            for (let j = 0; j < 16; j++) {
                let rotationAmount = 2 * Math.PI / 16 * j;
                let pivot = new THREE.Group();
                let mesh = new THREE.Mesh(geometry, cubeMaterial);
                mesh.position.set(i * 4 + boStart, 0, 5);
                mesh.rotation.x = Math.PI / 2;
                pivot.add(mesh);
                pivot.rotation.x = rotationAmount;
                scene.add(pivot);
            }
        }
    }

    function addDiana(scene) {
        let texture = loader.load('images/girls/Diana Ross/1.png');
        // let texture = loader.load('images/girls/Catherine Bach/1.png');
        texture.minFilter = THREE.LinearFilter;
        let material = new THREE.MeshLambertMaterial({
            map: texture,
            fog: true,
            side: THREE.DoubleSide,
            transparent: true
        });
        // preserve ratio
        let scale = 4;
        let geometry = new THREE.PlaneGeometry(scale * 570 / 799, scale);
        // let geometry = new THREE.PlaneGeometry(scale * 374 / 684, scale);
        let mesh = new THREE.Mesh(geometry, material);
        let loc = Utils.locationInSong(1, 0, 0);
        mesh.position.set(loc, 0, -1);
        mesh.rotation.y = -Math.PI / 2;
        mesh.rotation.x = Math.PI / 2;
        mesh.receiveShadow = false;
        mesh.castShadow = false;
        scene.add(mesh);
        return mesh;
    }


    function render3d() {
        // game.render(fpsAdjustment);
        let now = Date.now();

        // strut
        //camera.position.x += Math.sin(now / 100) * 0.02 + .025;
        // if (clock.eighthsFraction <= 34) {
        camera.position.x = clock.eighthsFraction + Math.sin(clock.eighthsFraction * Math.PI) * 0.15;
        // }


        // bounce
        camera.position.z = Math.cos(clock.eighthsFraction * Math.PI) * 0.03;

        // camera.rotation.y =  Math.PI / 2 * clock.bars;

        if (turningLeft) {
            camera.rotateOnWorldAxis(new THREE.Vector3(0, 0, 1), 2 * Math.PI / 180);
        }
        if (turningRight) {
            camera.rotateOnWorldAxis(new THREE.Vector3(0, 0, 1), -2 * Math.PI / 180);
        }

        rendererThree.render(scene, camera);
    }

    function render2d() {
        // activeScreen.render();
    }


    function onDocumentKeyDown(event) {
        if (!isPlaying) {
            // those_girls_you_know.oncanplaythrough = function () {
            those_girls_you_know.currentTime = clock.seconds;
            those_girls_you_know.play();
            // when music loaded, animate
            isPlaying = true;
            animate();
            // };
        }

        let keyCode = event["which"];
        if (keyCode === 37) {
            turningLeft = true;
        } else if (keyCode === 39) {
            turningRight = true;
        }
    }

    function onDocumentKeyUp(event) {
        let keyCode = event["which"];
        if (keyCode === 37) {
            turningLeft = false;
        } else if (keyCode === 39) {
            turningRight = false;
        }
    }

    function randomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
    }


</script>
<canvas id="screen">
    <h1>THOSE GIRLS YOU KNOWT</h1>

    <p>
        Those girls you know<br>
        Looking at the lenses of their phone<br>
        Minimize their blemishes<br>
        With downward angles<br>
        And tag<br>
        Their thoughts
    </p>

    <p>
        Now when you are<br>
        Following the mentions of a star<br>
        Their catchy, sassy, cutesy captions<br>
        Are designed to win<br>
        Your heart
    </p>

    <p>
        Underneath their makeup<br>
        Branding with their clothes<br>
        Underneath their makeup are those GIRLS
    </p>

    <p>
        Underneath your make up<br>
        Practicing your pose<br>
        Underneath your make up are those...
    </p>

    <p>
        ...Girls you know<br>
        Looking at the lenses of your phone<br>
        Minimize your blemishes<br>
        With downward angles<br>
        And tag<br>
        your thoughts

    </p>

</canvas>

</body>
</html>
